<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">

    <property name="uuid_type" value="uuid" dbms="h2"/>
    <property name="uuid_type" value="uuid" dbms="postgresql"/>
    <property name="uuid_type" value="varchar(255)" dbms="mysql"/>

    <property name="uuid_function" value="random_uuid()" dbms="h2"/>
    <property name="uuid_function" value="uuid_generate_v4()" dbms="postgresql"/>
    <property name="uuid_function" value="uuid()" dbms="mysql"/>

    <!-- Create auxiliary tables -->
    <changeSet author="pinnacl-team" id="ddl-0003-01-create-admissions-auxiliary-tables">

        <createTable tableName="admissions_metadata">
            <column name="id" type="${uuid_type}" defaultValueComputed="${uuid_function}">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="type" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="gender" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="data" type="jsonb">
                <constraints nullable="false"/>
            </column>
            <column name="owner_id" type="${uuid_type}"/>
            <column name="deleted" type="boolean" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="version" type="int" defaultValueNumeric="0"/>
            <column name="created_by" type="${uuid_type}"/>
            <column name="created_on" type="datetime" defaultValueComputed="NOW()">
                <constraints nullable="false"/>
            </column>
            <column name="updated_by" type="${uuid_type}"/>
            <column name="updated_on" type="datetime" defaultValueComputed="NOW()">
                <constraints nullable="false"/>
            </column>
        </createTable>


        <createTable tableName="admissions_question_answers">
            <column name="id" type="${uuid_type}" defaultValueComputed="${uuid_function}">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="type" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="answer" type="jsonb">
                <constraints nullable="false"/>
            </column>
            <column name="owner_id" type="${uuid_type}"/>
            <column name="deleted" type="boolean" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="version" type="int" defaultValueNumeric="0"/>
            <column name="created_by" type="${uuid_type}"/>
            <column name="created_on" type="datetime" defaultValueComputed="NOW()">
                <constraints nullable="false"/>
            </column>
            <column name="updated_by" type="${uuid_type}"/>
            <column name="updated_on" type="datetime" defaultValueComputed="NOW()">
                <constraints nullable="false"/>
            </column>
        </createTable>

    </changeSet>

    <changeSet author="pinnacl-team" id="ddl-0003-02-create-admissions-link-tables-and-foreign-keys">

        <createTable tableName="admissions">
            <column name="id" type="${uuid_type}" defaultValueComputed="${uuid_function}">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="type" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="owner_id" type="${uuid_type}"/>
            <column name="deleted" type="boolean" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="version" type="int" defaultValueNumeric="0"/>
            <column name="created_by" type="${uuid_type}"/>
            <column name="created_on" type="datetime" defaultValueComputed="NOW()">
                <constraints nullable="false"/>
            </column>
            <column name="updated_by" type="${uuid_type}"/>
            <column name="updated_on" type="datetime" defaultValueComputed="NOW()">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Link Tables & Foreign Keys -->
        <!-- _link_admissions_and_metadata -->
        <createTable tableName="_link_admissions_and_metadata">
            <column name="id" type="${uuid_type}" defaultValueComputed="${uuid_function}">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="admission_id" type="${uuid_type}">
                <constraints nullable="false"/>
            </column>
            <column name="metadata_id" type="${uuid_type}">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseColumnNames="metadata_id"
                                 baseTableName="_link_admissions_and_metadata"
                                 constraintName="fk_admission_and_metadata"
                                 deferrable="false"
                                 initiallyDeferred="false"
                                 onDelete="RESTRICT"
                                 onUpdate="RESTRICT"
                                 referencedColumnNames="id"
                                 referencedTableName="admissions_metadata"/>

        <addForeignKeyConstraint baseColumnNames="admission_id"
                                 baseTableName="_link_admissions_and_metadata"
                                 constraintName="fk_admissions_and_metadata"
                                 deferrable="false"
                                 initiallyDeferred="false"
                                 onDelete="RESTRICT"
                                 onUpdate="RESTRICT"
                                 referencedColumnNames="id"
                                 referencedTableName="admissions"/>

        <!-- _link_admissions_question_answers -->
        <createTable tableName="_link_admissions_and_question_answers">
            <column name="id" type="${uuid_type}" defaultValueComputed="${uuid_function}">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="admission_id" type="${uuid_type}">
                <constraints nullable="false"/>
            </column>
            <column name="question_answer_id" type="${uuid_type}">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseColumnNames="question_answer_id"
                                 baseTableName="_link_admissions_and_question_answers"
                                 constraintName="fk_admission_and_question_answers"
                                 deferrable="false"
                                 initiallyDeferred="false"
                                 onDelete="RESTRICT"
                                 onUpdate="RESTRICT"
                                 referencedColumnNames="id"
                                 referencedTableName="admissions_question_answers"/>

        <addForeignKeyConstraint baseColumnNames="admission_id"
                                 baseTableName="_link_admissions_and_question_answers"
                                 constraintName="fk_admissions_and_question_answer"
                                 deferrable="false"
                                 initiallyDeferred="false"
                                 onDelete="RESTRICT"
                                 onUpdate="RESTRICT"
                                 referencedColumnNames="id"
                                 referencedTableName="admissions"/>

        <!-- _link_admissions_and_documents -->
        <createTable tableName="_link_admissions_and_documents">
            <column name="id" type="${uuid_type}" defaultValueComputed="${uuid_function}">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="admission_id" type="${uuid_type}">
                <constraints nullable="false"/>
            </column>
            <column name="document_id" type="${uuid_type}">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseColumnNames="document_id"
                                 baseTableName="_link_admissions_and_documents"
                                 constraintName="fk_admission_and_documents"
                                 deferrable="false"
                                 initiallyDeferred="false"
                                 onDelete="RESTRICT"
                                 onUpdate="RESTRICT"
                                 referencedColumnNames="id"
                                 referencedTableName="forms_documents"/>

        <addForeignKeyConstraint baseColumnNames="admission_id"
                                 baseTableName="_link_admissions_and_documents"
                                 constraintName="fk_admissions_and_document"
                                 deferrable="false"
                                 initiallyDeferred="false"
                                 onDelete="RESTRICT"
                                 onUpdate="RESTRICT"
                                 referencedColumnNames="id"
                                 referencedTableName="admissions"/>

    </changeSet>

</databaseChangeLog>